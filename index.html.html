<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>우암 룰렛 v3.1 — 촬영용</title>
  <meta name="theme-color" content="#fb923c">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23f59e0b'/%3E%3Cpath d='M32 8v24l16 8' stroke='%23fff' stroke-width='6' fill='none' stroke-linecap='round'/%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    body { overscroll-behavior: none; margin: 0; padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
    * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-amber-50 to-orange-100 text-gray-900">
  <div id="root"></div>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    function App() {
      const defaultChargeStep = 1000;
      const defaultStepChanges = [-200, +300, -150, +500, -700, +200, -100];

      const [balance, setBalance] = useState(() => Number(localStorage.getItem("uomRoulette_balance") ?? 0));
      const [stepChanges, setStepChanges] = useState(() => JSON.parse(localStorage.getItem("uomRoulette_steps") ?? JSON.stringify(defaultStepChanges)));
      const [currentStep, setCurrentStep] = useState(() => Number(localStorage.getItem("uomRoulette_stepIndex") ?? 0));
      const [message, setMessage] = useState("");
      const [spinning, setSpinning] = useState(false);
      const [showSettings, setShowSettings] = useState(false);

      useEffect(() => { localStorage.setItem("uomRoulette_balance", String(balance)); }, [balance]);
      useEffect(() => { localStorage.setItem("uomRoulette_steps", JSON.stringify(stepChanges)); }, [stepChanges]);
      useEffect(() => { localStorage.setItem("uomRoulette_stepIndex", String(currentStep)); }, [currentStep]);

      const wheelRef = useRef(null);
      const [rotation, setRotation] = useState(0);
      const slices = React.useMemo(() => stepChanges.length || 1, [stepChanges]);
      const anglePerSlice = 360 / slices;

      const targetAngleForStep = (index) => {
        const sliceCenter = index * anglePerSlice + anglePerSlice / 2;
        return 360 * 5 + (360 - sliceCenter);
      };

      const fmt = (n) => (n >= 0 ? `+${n.toLocaleString()}` : n.toLocaleString());

      const charge = () => {
        const newBal = balance + defaultChargeStep;
        setBalance(newBal);
        setMessage(`충전: +${defaultChargeStep.toLocaleString()}원 → 잔액 ${newBal.toLocaleString()}원`);
        setCurrentStep(0);
      };

      const spin = async () => {
        if (spinning) return;
        if (!stepChanges.length) { setMessage("시나리오가 비어 있어요. 설정에서 추가해 주세요."); return; }
        const stepIndex = currentStep % stepChanges.length;
        const change = stepChanges[stepIndex];
        setSpinning(true);
        setRotation((prev) => prev + targetAngleForStep(stepIndex));
        await new Promise((r) => setTimeout(r, 2300));

        const isLast = stepIndex === stepChanges.length - 1;
        const newBal = balance + change;
        if (isLast) {
          setMessage("마지막 스텝: 0원이 되었습니다.");
          setBalance(0);
        } else {
          setBalance(newBal);
          setMessage(`변동: ${fmt(change)} → 잔액 ${newBal.toLocaleString()}원`);
        }
        setCurrentStep((i) => i + 1);
        await new Promise((r) => setTimeout(r, 200));
        setSpinning(false);
      };

      const fakeTransfer = () => {
        setBalance(0);
        setMessage("출금이 되지 않습니다.");
      };

      const totalPlannedChange = React.useMemo(() => stepChanges.reduce((a, b) => a + b, 0), [stepChanges]);

      const StepsList = () => (
        <div className="mt-3 grid grid-cols-2 gap-2 sm:grid-cols-3">
          {stepChanges.map((v, i) => (
            <div key={i} className={`rounded-xl px-3 py-2 text-center text-sm shadow ${ i === (currentStep % stepChanges.length) ? 'bg-black text-white' : 'bg-white/80' }`}>
              {i + 1}. {fmt(v)}원
            </div>
          ))}
        </div>
      );

      return (
        <div className="min-h-screen w-full">
          <div className="mx-auto max-w-md px-4 pb-36 pt-6 text-center">
            {/* 헤더 */}
            <div className="mb-4 flex items-center justify-between">
              <h1 className="text-2xl font-extrabold tracking-tight w-full text-center">우암 룰렛</h1>
              <button onClick={() => setShowSettings((v) => !v)} className="rounded-2xl bg-white px-3 py-1 text-sm shadow">⚙️ 설정</button>
            </div>

            {/* 잔액 박스 */}
            <div className="mb-4 rounded-3xl bg-white p-4 shadow text-center">
              <div className="text-sm opacity-70">현재 잔액</div>
              <div className="mt-1 text-4xl font-black tabular-nums">{balance.toLocaleString()}원</div>
              <div className="mt-4 flex flex-col items-center gap-3">
                <button onClick={charge} className="rounded-2xl bg-amber-500 px-4 py-3 font-bold text-white shadow active:scale-95 w-full max-w-[280px]">충전 1,000원</button>
              </div>
              <div className="mt-2 text-xs opacity-60">* 충전 버튼을 누를 때마다 1,000원이 누적 충전됩니다.</div>
            </div>

            {/* 룰렛 & 컨트롤 */}
            <div className="mb-4 rounded-3xl bg-white p-4 shadow text-center">
              <div className="mb-3 flex items-center justify-between">
                <div className="text-base font-bold w-full text-center">룰렛</div>
                <div className="text-xs opacity-60">스텝 {stepChanges.length ? currentStep % stepChanges.length : 0} / {stepChanges.length}</div>
              </div>

              <div className="relative mx-auto h-64 w-64 select-none mb-5 sm:mb-7">
                <div className="absolute left-1/2 top-0 z-20 -translate-x-1/2"><div className="h-6 w-2 rounded-b-xl bg-rose-600 shadow"></div></div>
                <div ref={wheelRef} className="absolute inset-0 z-10 rounded-full border-8 border-white shadow-lg transition-transform duration-[2200ms] ease-[cubic-bezier(0.19,1,0.22,1)]" style={{ transform: `rotate(${rotation}deg)` }}>
                  {Array.from({ length: slices }).map((_, i) => {
                    const start = i * anglePerSlice;
                    const bg = i % 2 === 0 ? "#fde68a" : "#fca5a5";
                    return (
                      <div key={i} className="absolute left-1/2 top-1/2 origin-top-left" style={{ transform: `rotate(${start}deg)` }}>
                        <div className="flex h-32 w-32 -translate-y-full -translate-x-full items-center justify-center rounded-br-full text-xs font-extrabold" style={{ background: bg }}>{fmt(stepChanges[i] ?? 0)}원</div>
                      </div>
                    );
                  })}
                </div>
              </div>

              <div className="mt-6 flex flex-col items-center gap-3">
                <button onClick={spin} disabled={spinning} className={`rounded-2xl px-5 py-3 text-base font-extrabold shadow active:scale-95 w-full max-w-[280px] ${spinning ? 'bg-gray-300 text-gray-600' : 'bg-rose-600 text-white'}`}>{spinning ? "회전 중..." : "룰렛 시작"}</button>
                <button onClick={fakeTransfer} className="rounded-2xl bg-gray-100 px-4 py-3 text-base font-bold shadow active:scale-95 w-full max-w-[280px]">계좌이체 10,000원</button>
              </div>

              {!!message && (<div className="mt-3 rounded-2xl bg-emerald-50 p-3 text-sm text-emerald-800 text-center">{message}</div>)}
            </div>

            {showSettings && (
              <div className="mb-4 rounded-3xl bg-white p-4 shadow text-center">
                <div className="mb-2 flex items-center justify-between">
                  <div className="text-base font-bold w-full text-center">시나리오 설정</div>
                  <button className="rounded-xl bg-gray-100 px-3 py-1 text-sm" onClick={() => { setStepChanges(defaultStepChanges); setCurrentStep(0); setMessage('시나리오가 기본값으로 복원되었습니다.'); }}>기본값으로</button>
                </div>
                <div className="rounded-2xl bg-amber-50 p-3 text-sm">쉼표로 금액 변화를 나열하세요. (예: -200, +300, -150, +500)</div>
                <textarea className="mt-2 h-28 w-full rounded-2xl border p-3 font-mono text-sm text-center" defaultValue={stepChanges.map((n) => (n >= 0 ? `+${n}` : `${n}`)).join(", ")} onBlur={(e) => { try { const text = e.target.value.replace(/\s+/g, ""); if (!text) { setStepChanges([]); return; } const arr = text.split(",").map((t) => Number(t)); if (arr.some((x) => Number.isNaN(x))) throw new Error("숫자만 입력"); setStepChanges(arr); setCurrentStep(0); setMessage("시나리오가 적용되었습니다."); } catch { setMessage("형식을 확인해 주세요. 예: -200, +300, -150"); } }}></textarea>
                <div className="mt-2 grid grid-cols-2 gap-2 text-sm">
                  <div className="rounded-2xl bg-gray-50 p-3">
                    <div className="opacity-60">총 변화(합계)</div>
                    <div className="text-lg font-extrabold">{fmt(totalPlannedChange)}원</div>
                  </div>
                  <div className="rounded-2xl bg-gray-50 p-3">
                    <div className="opacity-60">현재 스텝</div>
                    <div className="text-lg font-extrabold">{(stepChanges.length ? (currentStep % stepChanges.length) : 0) + 1} / {stepChanges.length || 1}</div>
                  </div>
                </div>
                <StepsList />
              </div>
            )}

            <div className="mt-6 text-center text-xs opacity-60">© 우암 룰렛 — 촬영용 데모 앱 / 실제 금전 거래 기능 없음</div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
